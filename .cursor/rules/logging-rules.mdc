---
description: 
globs: 
alwaysApply: true
---
Rule Type: Always
This rule is attached to every chat and command+k request involving error handling, API development, or significant business logic.

---

### Purpose
Ensure consistent, effective, and secure logging practices throughout the FinSight AI Dashboard application, utilizing Winston and Firestore for structured logging.

---

### Tasks this rule is helpful for
- Implementing logging for errors, warnings, and informational events.
- Structuring log data for better analysis and debugging.
- Managing log levels and destinations.
- Ensuring sensitive data is not logged.

---

### Tag files with:
- `@lib/logger.ts` (Winston logger configuration)
- `@app/api/` (API routes for logging critical backend events)
- `@services/` (Service layer for logging business logic events or third-party API interactions)
- `@utils/errorHandler.ts` (Global error handling utilities that incorporate logging)
- `@store/slices/` (For logging critical state changes or errors during async operations if not handled by services)

---

### Explicit Rules for Logging

1.  **Logger Configuration (`@lib/logger.ts`):**
    *   Centralize Winston logger configuration in `src/lib/logger.ts`.
    *   Configure transports: Console transport for development, Firestore transport for staging/production.
    *   Define a consistent log format (e.g., JSON) including timestamp, level, message, and relevant metadata (e.g., `userId`, `requestId`, `module`).

2.  **Log Levels:**
    *   Use appropriate log levels:
        *   `error`: For unhandled exceptions, critical failures, security incidents.
        *   `warn`: For unexpected situations that don't break functionality but should be investigated (e.g., deprecated API usage, minor validation failures).
        *   `info`: For important operational events (e.g., user login, successful payment, major feature usage).
        *   `http`: For HTTP request logging (method, URL, status code, duration) - often handled by middleware.
        *   `debug`: For detailed diagnostic information useful during development (should be disabled or have a separate transport in production).
    *   Set default log level based on environment (e.g., `info` for production, `debug` for development).

3.  **What to Log:**
    *   **Errors:** Always log unhandled exceptions and significant errors with stack traces and relevant context (e.g., request data, user ID).
    *   **Security Events:** Log critical security-related events (e.g., failed login attempts, permission denied, potential XSS/CSRF attempts if detectable).
    *   **API Requests/Responses:** Log key aspects of API calls (especially to third-party services like Plaid, OpenAI), including endpoint, status, and duration. Be cautious with logging full request/response bodies if they contain PII.
    *   **Business Logic:** Log important milestones or decisions in critical business logic flows.
    *   **User Actions:** Log key user actions for audit trails or analytics if necessary (e.g., account creation, linking bank account, generating insight).

4.  **What NOT to Log (Security & Privacy):**
    *   **NEVER log sensitive Personal Identifiable Information (PII)** such as passwords, full credit card numbers, bank account numbers, API keys, secrets, or raw session tokens.
    *   If user-specific data is logged for debugging, ensure it's anonymized or pseudonymized where possible, or that access to these logs is strictly controlled.
    *   Sanitize or filter log data to prevent accidental logging of sensitive information.

5.  **Structured Logging:**
    *   Log data in a structured format (preferably JSON) to facilitate searching, filtering, and analysis in Firestore or other log management tools.
    *   Include a `context` object in logs for additional structured data relevant to the event.
    *   Example:
        ```javascript
        logger.error('Failed to process payment', {
          userId: 'user123',
          orderId: 'order456',
          errorMessage: err.message,
          component: 'PaymentService'
        });
        ```

6.  **Correlation:**
    *   Include a `requestId` or `correlationId` in logs related to a single operation or user request. This helps trace an event across different services or modules.
    *   For user-specific logs, include `userId` or `sessionId` where appropriate and permissible.

7.  **Log Review & Monitoring:**
    *   Regularly review logs, especially error and warning levels, to identify issues.
    *   Set up alerts for high-priority errors or unusual log patterns in Firestore (if supported) or by exporting logs to a dedicated monitoring service.

8.  **Firestore Logging Transport:**
    *   Configure the Winston Firestore transport to write logs to a dedicated Firestore collection (e.g., `app-logs`).
    *   Ensure appropriate indexes are set up on the logs collection for efficient querying (e.g., on `timestamp`, `level`, `userId`).
    *   Implement a data retention policy for logs in Firestore to manage costs and storage (e.g., delete logs older than 90 days).

---

**All logging implementations must adhere to these rules to ensure effective debugging, monitoring, and security.**

