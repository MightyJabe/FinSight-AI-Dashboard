---
description: 
globs: 
alwaysApply: true
---
Rule Type: Always
This rule is attached to every chat and command+k request for API development.


---

### Purpose
Ensure all API routes in the FinSight AI Dashboard project use Zod for input validation, following security and data integrity best practices, and align with logging and error handling standards.


---

### Tasks this rule is helpful for
- Enforcing input validation in all API endpoints.
- Preventing unvalidated or unsafe data from being processed.
- Maintaining consistent API error handling and response structures.
- Ensuring compliance with project security standards.
- Integrating API validation with logging practices.


---

### Tag files with:
- @src/app/api/ (all API route files)
- @src/types/zod.ts (if using shared Zod schemas)
- @src/services/ (if any service layer also validates input, though primarily API responsibility)
- `@lib/logger.ts` (for logging validation failures)


---

### Explicit Rule: API Input Validation with Zod

1.  **Mandatory Zod Validation:**
    *   All API routes within `src/app/api/` (and any custom API route directories) **must** use Zod schemas to validate incoming request data (body, query parameters, path parameters) before any processing occurs.
    *   This is a critical security measure to prevent injection attacks, malformed data, and unexpected behavior.

2.  **Schema Definition:**
    *   Each API file should import Zod (`import { z } from 'zod';`).
    *   Define a Zod schema clearly specifying the expected shape, types, and constraints (e.g., `min`, `max`, `email`, `url`) for the input.
    *   For complex or reusable schemas, consider defining them in a shared location like `src/types/zod.ts` or co-located `*.schemas.ts` files, then import them into the API route.

3.  **Validation Logic:**
    *   Use `schema.safeParse(req.body)` (or `req.query`, `params` from Next.js route handlers) to validate input.
    *   **If validation fails (`!parsed.success`):**
        *   Immediately return a `400 Bad Request` HTTP status code.
        *   The JSON response body **must** include a structured error object detailing the validation issues, typically derived from `parsed.error.formErrors.fieldErrors` or `parsed.error.errors` for a flatter list.
        *   Log the validation failure event, including the specific errors and relevant request identifiers (e.g., IP, user ID if available), using the centralized logger (see `logging-rules.mdc`). Do **not** log sensitive parts of the request body directly if they failed validation due to PII concerns.
        *   Example error response:
            ```json
            { "success": false, "errors": { "fieldName": ["Error message 1"], "otherField": ["Error message A"] } }
            ```
    *   **If validation succeeds (`parsed.success`):**
        *   Proceed with processing using `parsed.data`, which is now type-safe.

4.  **Untrusted Input:**
    *   Never process, store, or pass unvalidated input to other services or database queries.
    *   Treat all incoming client data as untrusted until successfully validated by Zod.

5.  **Error Handling Post-Validation:**
    *   For errors occurring *after* successful validation (e.g., business logic errors, database errors), use appropriate 4xx or 5xx HTTP status codes and a consistent error response format.
    *   Refer to global error handling and logging rules (`curser-rules.mdc`, `logging-rules.mdc`).

6.  **Documentation:**
    *   Zod schemas serve as partial documentation for API request payloads. Ensure they are clear and well-commented if complex.
    *   Complement with JSDoc or other API documentation for endpoint purpose, authentication requirements, and response structures.


---

**All API contributions must strictly follow this rule for security, data integrity, and maintainability.**



